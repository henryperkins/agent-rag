<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frontend Fetch Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    button {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 14px;
      cursor: pointer;
    }
    #output {
      background: #f5f5f5;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      white-space: pre-wrap;
      font-size: 12px;
      max-height: 500px;
      overflow-y: auto;
    }
    .error { color: red; }
    .success { color: green; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>Frontend Fetch Diagnostic Tool</h1>
  <p>Test network connectivity to backend through different paths:</p>

  <div>
    <button onclick="testRelativePath()">Test Relative Path (/chat/stream)</button>
    <button onclick="testProxyPath()">Test Proxy (http://localhost:5173/chat/stream)</button>
    <button onclick="testDirectBackend()">Test Direct Backend (http://localhost:8787/chat/stream)</button>
    <button onclick="clearOutput()">Clear</button>
  </div>

  <h2>Output:</h2>
  <div id="output"></div>

  <script>
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const timestamp = new Date().toISOString().split('T')[1].slice(0, 12);
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    async function testFetch(url, description) {
      log(`\n=== ${description} ===`, 'info');
      log(`URL: ${url}`, 'info');

      const payload = {
        messages: [{ role: 'user', content: 'hello test' }],
        sessionId: 'test-' + Date.now()
      };

      try {
        log('Sending request...', 'info');
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        log(`Response headers:`, 'info');
        for (const [key, value] of response.headers.entries()) {
          log(`  ${key}: ${value}`, 'info');
        }

        if (!response.ok || !response.body) {
          const text = await response.text();
          log(`Error body: ${text}`, 'error');
          return;
        }

        log('Reading stream...', 'info');
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let eventCount = 0;

        while (eventCount < 5) {
          const { value, done } = await reader.read();
          if (done) {
            log('Stream complete', 'success');
            break;
          }

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\\n');

          for (const line of lines) {
            if (line.trim() && line.startsWith('event:')) {
              eventCount++;
              log(`Received: ${line}`, 'success');
            } else if (line.trim() && line.startsWith('data:')) {
              log(`  ${line.substring(0, 100)}...`, 'info');
            }
          }
        }

        reader.cancel();
        log(`✓ Test successful! Received ${eventCount} events`, 'success');

      } catch (error) {
        log(`✗ Fetch failed: ${error.message}`, 'error');
        log(`Error stack: ${error.stack}`, 'error');
        log(`Error type: ${error.constructor.name}`, 'error');
      }
    }

    function testRelativePath() {
      testFetch('/chat/stream', 'Relative Path (Vite Proxy)');
    }

    function testProxyPath() {
      testFetch('http://localhost:5173/chat/stream', 'Full URL via Proxy');
    }

    function testDirectBackend() {
      testFetch('http://localhost:8787/chat/stream', 'Direct Backend (may have CORS issues)');
    }

    // Auto-run test on load
    log('Test page loaded. Click buttons above to test different endpoints.', 'info');
  </script>
</body>
</html>
